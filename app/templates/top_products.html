{% extends "base.html" %}

{% block content %}
<h1>Top Products</h1>

<div style="display:flex; gap:12px; align-items:center; margin-bottom:18px;">
  <!-- Search form (submit on Enter or button) -->
  <form id="search-form" style="display:flex; gap:8px; align-items:center; margin:0;">
    <input id="search-box" name="q" type="search" placeholder="Search products..." class="form-control" style="max-width:320px;">
    <button id="search-btn" type="submit" class="btn btn-primary">Search</button>
    <button id="clear-search-btn" type="button" class="btn btn-light">Clear</button>
  </form>

  <!-- Sorting dropdown -->
  <label for="sort-select" style="margin-left:12px;">Sort</label>
  <select id="sort-select" class="form-select" style="max-width:220px; margin-left:6px;">
      <option value="price_high">Price: High → Low (default)</option>
      <option value="price_low">Price: Low → High</option>
      <option value="az">A → Z</option>
      <option value="za">Z → A</option>
      <option value="rating">Avg Rating</option>
  </select>
</div>

<table id="products-table" class="table table-hover table-bordered container">
    <thead>
      <tr>
          <th>Product Name</th>
          <th>Price</th>
          <th>Available</th>
          <th>Avg Rating</th>
          <th>Actions</th>
      </tr>
    </thead>
    <tbody id="products-body">
    </tbody>
</table>

<script>
const csrfToken = {{ csrf_token()|tojson }};

// render helper
function renderProducts(products) {
    const tbody = document.getElementById('products-body');
    tbody.innerHTML = '';

    if (!products || products.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="5">No products found.</td>`;
        tbody.appendChild(tr);
        return;
    }

    products.forEach(product => {
        const tr = document.createElement('tr');
        // avg_rating may be undefined/null
        const avg = (product.avg_rating === null || product.avg_rating === undefined) ? '—' : Number(product.avg_rating).toFixed(2);

        tr.innerHTML = `
            <td><a href="/products/${product.id}">${product.name}</a></td>
            <td>${product.price}</td>
            <td>${product.available ? "Yes" : "No"}</td>
            <td>${avg}</td>
            <td>
              <div style="display:flex; gap:6px;">
                ${product.available ? `
                <form action="/cart/add/${product.id}" method="POST" style="margin:0;">
                  <input type="hidden" name="csrf_token" value="${csrfToken}">
                  <input type="submit" value="Add to Cart" class="btn btn-sm btn-outline-primary"/>
                </form>` : ''}
                
                <!-- Wishlist form (POST) -->
                <form action="/wishlist/add/${product.id}" method="POST" style="margin:0;">
                  <input type="hidden" name="csrf_token" value="${csrfToken}">
                  <input type="submit" value="Wishlist" class="btn btn-sm btn-outline-secondary"/>
                </form>
              </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// utility to fetch /api/products/filter with current sort
async function fetchFiltered(sort='price_high') {
    const res = await fetch(`/api/products/filter?sort=${encodeURIComponent(sort)}`);
    if (!res.ok) {
        console.error('Failed to fetch products', await res.text());
        return [];
    }
    return res.json();
}

// utility to search
async function fetchSearch(q) {
    const res = await fetch(`/api/products/search?q=${encodeURIComponent(q)}`);
    if (!res.ok) {
        console.error('Search failed', await res.text());
        return [];
    }
    return res.json();
}

// initialize: default to price_high (high→low)
async function init() {
    const defaultSort = document.getElementById('sort-select').value || 'price_high';
    const products = await fetchFiltered(defaultSort);
    renderProducts(products);
}
init();

// wire sort changes
document.getElementById('sort-select').addEventListener('change', async (e) => {
    const sort = e.target.value;
    const products = await fetchFiltered(sort);
    renderProducts(products);
});

// search form: works on Enter and button click
document.getElementById('search-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const q = document.getElementById('search-box').value.trim();
    if (!q) {
        // if empty, load filter default
        const products = await fetchFiltered(document.getElementById('sort-select').value);
        renderProducts(products);
        return;
    }
    const products = await fetchSearch(q);
    renderProducts(products);
});

// clear search
document.getElementById('clear-search-btn').addEventListener('click', async () => {
    document.getElementById('search-box').value = '';
    const products = await fetchFiltered(document.getElementById('sort-select').value);
    renderProducts(products);
});
</script>
{% endblock %}
