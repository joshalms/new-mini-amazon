{% extends "base.html" %}

{% block content %}

<h1>Top Products</h1>

<div style="display:flex; flex-wrap:wrap; gap:14px; align-items:center; margin-bottom:18px;">

  <!-- Search form -->

  <form id="search-form" style="display:flex; gap:8px; align-items:center; margin:0;">
    <input id="search-box" name="q" type="search"
           placeholder="Search products..." class="form-control"
           style="max-width:320px;">
    <button id="search-btn" type="submit" class="btn btn-primary">Search</button>
    <button id="clear-search-btn" type="button" class="btn btn-light">Clear</button>
  </form>

  <!-- Sorting dropdown -->

  <div style="display:flex; align-items:center; gap:6px;">
    <label for="sort-select" style="margin:0;">Sort:</label>
    <select id="sort-select" class="form-select" style="max-width:220px;">
        <option value="price_high">Price: High → Low</option>
        <option value="price_low">Price: Low → High</option>
        <option value="az">A → Z</option>
        <option value="za">Z → A</option>
    </select>
  </div>
</div>

<table id="products-table" class="table table-hover table-bordered container">
    <thead>
      <tr>
          <th>Product Name</th>
          <th>Price</th>
          <th>Available</th>
          <th style="text-align:center;">Actions</th>
      </tr>
    </thead>
    <tbody id="products-body"></tbody>
</table>

<!-- Pagination -->

<nav>
  <ul id="pagination" class="pagination justify-content-center mt-3"></ul>
</nav>

<script>
const csrfToken = {{ csrf_token()|tojson }};
let currentPage = 1;
let totalPages = 1;
let currentQuery = '';
let currentSort = document.getElementById('sort-select').value;

// Render products
function renderProducts(products) {
    const tbody = document.getElementById('products-body');
    tbody.innerHTML = '';

    if (!products || products.items.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="4">No products found.</td>`;
        tbody.appendChild(tr);
        return;
    }

    products.items.forEach(product => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><a href="/products/${product.id}">${product.name}</a></td>
            <td>${product.price}</td>
            <td>${product.available ? "Yes" : "No"}</td>
            <td>
              <div style="display:flex; gap:8px; justify-content:center;">
                ${product.available ? `
                <form action="/cart/add/${product.id}" method="POST" style="margin:0;">
                  <input type="hidden" name="csrf_token" value="${csrfToken}">
                  <input type="submit" value="Add to Cart" class="btn btn-sm btn-primary"/>
                </form>` : ''}

                <form action="/wishlist/add/${product.id}" method="POST" style="margin:0;">
                  <input type="hidden" name="csrf_token" value="${csrfToken}">
                  <input type="submit" value="Wishlist" class="btn btn-sm btn-success"/>
                </form>
              </div>
            </td>
        `;
        tbody.appendChild(tr);
    });

    totalPages = products.total_pages;
    renderPagination();
}

// Render pagination
function renderPagination() {
    const ul = document.getElementById('pagination');
    ul.innerHTML = '';

    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#">Previous</a>`;
    prevLi.addEventListener('click', e => {
        e.preventDefault();
        if (currentPage > 1) {
            currentPage--;
            loadProducts();
        }
    });
    ul.appendChild(prevLi);

    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        li.addEventListener('click', (e) => {
            e.preventDefault();
            if (i !== currentPage) {
                currentPage = i;
                loadProducts();
            }
        });
        ul.appendChild(li);
    }

    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#">Next</a>`;
    nextLi.addEventListener('click', e => {
        e.preventDefault();
        if (currentPage < totalPages) {
            currentPage++;
            loadProducts();
        }
    });
    ul.appendChild(nextLi);
}

// Fetch products
async function loadProducts() {
    let url;
    if (currentQuery) {
        url = `/api/products/search?q=${encodeURIComponent(currentQuery)}&page=${currentPage}&sort=${currentSort}`;
    } else {
        url = `/api/products/filter?sort=${currentSort}&page=${currentPage}`;
    }
    const res = await fetch(url);
    if (!res.ok) return renderProducts({ items: [], total_pages: 1 });
    const data = await res.json();
    renderProducts(data);
}

// Initial load
loadProducts();

// Sort change
document.getElementById('sort-select').addEventListener('change', (e) => {
    currentSort = e.target.value;
    currentPage = 1;
    loadProducts();
});

// Search submit
document.getElementById('search-form').addEventListener('submit', (e) => {
    e.preventDefault();
    currentQuery = document.getElementById('search-box').value.trim();
    currentPage = 1;
    loadProducts();
});

// Clear search
document.getElementById('clear-search-btn').addEventListener('click', () => {
    document.getElementById('search-box').value = '';
    currentQuery = '';
    currentPage = 1;
    loadProducts();
});
</script>

{% endblock %}
