{% extends "base.html" %}

{% block content %}
<h1>Top Products</h1>

<div style="display:flex; flex-wrap:wrap; gap:14px; align-items:center; margin-bottom:18px;">
  
  <!-- Search form -->
  <form id="search-form" style="display:flex; gap:8px; align-items:center; margin:0;">
    <input id="search-box" name="q" type="search"
           placeholder="Search products..." class="form-control"
           style="max-width:320px;">
    <button id="search-btn" type="submit" class="btn btn-primary">Search</button>
    <button id="clear-search-btn" type="button" class="btn btn-light">Clear</button>
  </form>

  <!-- Sorting dropdown -->
  <div style="display:flex; align-items:center; gap:6px;">
    <label for="sort-select" style="margin:0;">Sort:</label>
    <select id="sort-select" class="form-select" style="max-width:220px;">
        <option value="price_high">Price: High → Low</option>
        <option value="price_low">Price: Low → High</option>
        <option value="az">A → Z</option>
        <option value="za">Z → A</option>
    </select>
  </div>
</div>

<table id="products-table" class="table table-hover table-bordered container">
    <thead>
      <tr>
          <th>Product Name</th>
          <th>Price</th>
          <th>Available</th>
          <th style="text-align:center;">Actions</th>
      </tr>
    </thead>
    <tbody id="products-body"></tbody>
</table>

<script>
const csrfToken = {{ csrf_token()|tojson }};

// render helper
function renderProducts(products) {
    const tbody = document.getElementById('products-body');
    tbody.innerHTML = '';

    if (!products || products.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="4">No products found.</td>`;
        tbody.appendChild(tr);
        return;
    }

    products.forEach(product => {
        const tr = document.createElement('tr');

        tr.innerHTML = `
            <td><a href="/products/${product.id}">${product.name}</a></td>
            <td>${product.price}</td>
            <td>${product.available ? "Yes" : "No"}</td>
            <td>
              <div style="display:flex; gap:8px; justify-content:center;">
                ${product.available ? `
                <form action="/cart/add/${product.id}" method="POST" style="margin:0;">
                  <input type="hidden" name="csrf_token" value="${csrfToken}">
                  <input type="submit" value="Add to Cart" class="btn btn-sm btn-primary"/>
                </form>` : ''}

                <form action="/wishlist/add/${product.id}" method="POST" style="margin:0;">
                  <input type="hidden" name="csrf_token" value="${csrfToken}">
                  <input type="submit" value="Wishlist" class="btn btn-sm btn-success"/>
                </form>
              </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// API utilities
async function fetchFiltered(sort='price_high') {
    const res = await fetch(`/api/products/filter?sort=${encodeURIComponent(sort)}`);
    if (!res.ok) return [];
    return res.json();
}

async function fetchSearch(q) {
    const res = await fetch(`/api/products/search?q=${encodeURIComponent(q)}`);
    if (!res.ok) return [];
    return res.json();
}

// init
async function init() {
    const defaultSort = document.getElementById('sort-select').value;
    renderProducts(await fetchFiltered(defaultSort));
}
init();

// Sort change
document.getElementById('sort-select').addEventListener('change', async (e) => {
    renderProducts(await fetchFiltered(e.target.value));
});

// Search
document.getElementById('search-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const q = document.getElementById('search-box').value.trim();
    if (!q) {
        renderProducts(await fetchFiltered(document.getElementById('sort-select').value));
        return;
    }
    renderProducts(await fetchSearch(q));
});

// Clear search
document.getElementById('clear-search-btn').addEventListener('click', async () => {
    document.getElementById('search-box').value = '';
    renderProducts(await fetchFiltered(document.getElementById('sort-select').value));
});
</script>
{% endblock %}
