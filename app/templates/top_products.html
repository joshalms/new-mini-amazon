{% extends "base.html" %}

{% block content %}
<h1>Top Products</h1>

<div style="display:flex; gap:20px; margin-bottom:20px;">
    <!-- Search Bar -->
    <input id="search-box" type="text" placeholder="Search products..." class="form-control" style="max-width:250px;">
    <button id="search-btn" class="btn btn-primary">Search</button>

    <!-- Sorting dropdown -->
    <select id="sort-select" class="form-select" style="max-width:200px;">
        <option value="az">A → Z</option>
        <option value="za">Z → A</option>
        <option value="price_low">Price: Low → High</option>
        <option value="price_high">Price: High → Low</option>
        <option value="rating">Avg Rating</option>
    </select>
</div>

<form id="top-k-form" style="margin-bottom:20px;">
    <label for="k">Top K most expensive:</label>
    <input type="number" name="k" id="k" min="1" value="5">
    <button type="submit" class="btn btn-secondary">Show Top K</button>
</form>

<table id="products-table" class="table table-hover table-bordered container">
    <tr>
        <th>Product Name</th>
        <th>Price</th>
        <th>Available</th>
        <th>Add to Cart</th>
    </tr>
</table>

<script>
const csrfToken = {{ csrf_token()|tojson }};

function renderProducts(products) {
    const table = document.getElementById('products-table');
    table.innerHTML = `
        <tr>
            <th>Product Name</th>
            <th>Price</th>
            <th>Available</th>
            <th>Add to Cart</th>
        </tr>
    `;

    products.forEach(product => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <a href="/products/${product.id}">
                    ${product.name}
                </a>
            </td>
            <td>${product.price}</td>
            <td>${product.available ? "Yes" : "No"}</td>
            <td>
                ${product.available ? `
                    <form action="/cart/add/${product.id}" method="POST">
                        <input type="hidden" name="csrf_token" value="${csrfToken}">
                        <input type="submit" value="Add to Cart" class="btn btn-sm btn-outline-primary"/>
                    </form>
                ` : ""}
            </td>
        `;
        table.appendChild(row);
    });
}

// Load top K initially
fetch(`/api/products/topk?k=5`)
    .then(r => r.json())
    .then(renderProducts);

// Top-K form
document.getElementById("top-k-form").addEventListener("submit", (e) => {
    e.preventDefault();
    const k = document.getElementById("k").value;
    fetch(`/api/products/topk?k=${k}`)
        .then(r => r.json())
        .then(renderProducts);
});

// Search
document.getElementById("search-btn").addEventListener("click", () => {
    const q = document.getElementById("search-box").value;
    fetch(`/api/products/search?q=${q}`)
        .then(r => r.json())
        .then(renderProducts);
});

// Sorting
document.getElementById("sort-select").addEventListener("change", () => {
    const sort = document.getElementById("sort-select").value;
    fetch(`/api/products/filter?sort=${sort}`)
        .then(r => r.json())
        .then(renderProducts);
});
</script>

{% endblock %}
