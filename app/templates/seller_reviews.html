{% extends "base.html" %} {% block content %}
<div class="container" style="max-width: 800px; margin-top: 40px">
    <h2>User Seller Reviews</h2>
    <p class="text-muted">
        Find the 5 most recent seller reviews posted by any user
    </p>

    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title">Enter User ID</h5>
            <form id="reviewForm" class="form-inline">
                <div class="form-group mr-3">
                    <label for="userId" class="mr-2">User ID:</label>
                    <input
                        type="number"
                        class="form-control"
                        id="userId"
                        name="userId"
                        placeholder="e.g., 1"
                        min="1"
                        required
                        style="width: 120px"
                    />
                </div>
                <button type="submit" class="btn btn-primary">
                    Get Reviews
                </button>
            </form>
            <small class="form-text text-muted mt-2"
                >Try User ID 1 (Alex Chen) or 2 (Maria Gomez)</small
            >
        </div>
    </div>

    <div id="resultsSection" style="display: none" class="mt-4">
        <h4>Reviews by <span id="userName"></span></h4>
        <p class="text-muted">Showing up to 5 most recent reviews</p>
        <div id="reviewsList"></div>
    </div>

    <div
        id="errorSection"
        style="display: none"
        class="alert alert-warning mt-4"
    >
        <strong>No reviews found</strong> for this user.
    </div>
</div>

<script>
    document
        .getElementById("reviewForm")
        .addEventListener("submit", async function (e) {
            e.preventDefault();

            const userId = document.getElementById("userId").value;
            const resultsSection = document.getElementById("resultsSection");
            const errorSection = document.getElementById("errorSection");
            const reviewsList = document.getElementById("reviewsList");
            const userName = document.getElementById("userName");

            // Hide previous results
            resultsSection.style.display = "none";
            errorSection.style.display = "none";
            reviewsList.innerHTML =
                '<p class="text-center"><em>Loading...</em></p>';

            try {
                // Fetch reviews from API
                const response = await fetch(
                    `/api/users/${userId}/seller-reviews`,
                );
                const data = await response.json();

                if (data.reviews && data.reviews.length > 0) {
                    // Fetch user info
                    const userResponse = await fetch(`/users/${userId}`);
                    const userHtml = await userResponse.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(userHtml, "text/html");

                    // Find the name in the parsed HTML
                    let name = `User ${userId}`;
                    const paragraphs = doc.querySelectorAll("p");
                    for (let p of paragraphs) {
                        if (p.textContent.includes("Name:")) {
                            name = p.textContent.replace("Name:", "").trim();
                            break;
                        }
                    }

                    userName.textContent = name;

                    // Display reviews
                    let html = "";
                    data.reviews.forEach((review, index) => {
                        const date = new Date(review.created_at);
                        const formattedDate = date.toLocaleDateString("en-US", {
                            year: "numeric",
                            month: "long",
                            day: "numeric",
                            hour: "2-digit",
                            minute: "2-digit",
                        });

                        const stars =
                            "★".repeat(review.rating) +
                            "☆".repeat(5 - review.rating);

                        html += `
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="card-subtitle mb-2">Review for Seller ID: ${review.seller_id}</h6>
                  <div class="text-warning mb-2" style="font-size: 1.2em;">${stars}</div>
                </div>
                <small class="text-muted">${formattedDate}</small>
              </div>
              <p class="card-text">${review.body || "<em>No comment provided</em>"}</p>
            </div>
          </div>
        `;
                    });

                    reviewsList.innerHTML = html;
                    resultsSection.style.display = "block";
                } else {
                    errorSection.style.display = "block";
                }
            } catch (error) {
                console.error("Error fetching reviews:", error);
                reviewsList.innerHTML =
                    '<p class="text-danger">Error loading reviews. Please try again.</p>';
                resultsSection.style.display = "block";
            }
        });
</script>
{% endblock %}
