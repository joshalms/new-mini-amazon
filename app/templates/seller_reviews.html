{% extends "base.html" %}
{% block content %}
<div class="container" style="max-width: 800px; margin-top: 40px;">
  <h2>Seller Reviews Explorer</h2>
  <p class="text-muted">Look up the 5 most recent seller reviews for any user ID.</p>

  <div class="card mt-4">
    <div class="card-body">
      <h5 class="card-title">Lookup seller</h5>
      <form id="reviewForm" class="form-inline">
        <div class="form-group mr-3">
          <label for="userId" class="mr-2">User ID</label>
          <input
            type="number"
            class="form-control"
            id="userId"
            name="userId"
            min="1"
            required
            style="width: 140px;"
            value="{{ default_user_id }}"
          >
        </div>
        <button type="submit" class="btn btn-primary">Get Reviews</button>
      </form>
      <small class="form-text text-muted mt-2">
        Hint: try IDs 1–10 for seeded demo accounts.
      </small>
    </div>
  </div>

  <div id="statusArea" class="mt-3"></div>

  <div id="resultsSection" style="display: none;" class="mt-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4 class="mb-0">
        Seller: <span id="sellerName"></span>
        <small class="text-muted" id="sellerEmail"></small>
      </h4>
      <div id="sellerSummary" class="text-right text-muted"></div>
    </div>
    <div id="reviewsList"></div>
  </div>
</div>

<script>
(function() {
  const form = document.getElementById('reviewForm');
  const userIdInput = document.getElementById('userId');
  const statusArea = document.getElementById('statusArea');
  const resultsSection = document.getElementById('resultsSection');
  const sellerNameEl = document.getElementById('sellerName');
  const sellerEmailEl = document.getElementById('sellerEmail');
  const sellerSummaryEl = document.getElementById('sellerSummary');
  const reviewsList = document.getElementById('reviewsList');

  const escBuffer = document.createElement('div');

  function escapeHtml(value) {
    if (value === undefined || value === null) {
      return '';
    }
    escBuffer.textContent = value;
    return escBuffer.innerHTML;
  }

  function setStatus(message, isError) {
    const css = isError ? 'alert alert-danger' : 'alert alert-info';
    statusArea.innerHTML = '<div class="' + css + '">' + message + '</div>';
  }

  function clearStatus() {
    statusArea.innerHTML = '';
  }

  function formatDate(value) {
    if (!value) return '';
    const date = new Date(value);
    return date.toLocaleString();
  }

  form.addEventListener('submit', async function(event) {
    event.preventDefault();
    const userId = userIdInput.value.trim();
    if (!userId) {
      setStatus('Please enter a user ID.', true);
      return;
    }

    resultsSection.style.display = 'none';
    reviewsList.innerHTML = '';
    setStatus('Loading seller reviews…', false);

    try {
      const response = await fetch(`/api/users/${encodeURIComponent(userId)}/seller-reviews`);
      if (!response.ok) {
        if (response.status === 404) {
          setStatus('User not found.', true);
        } else {
          setStatus('Unable to load reviews (status ' + response.status + ').', true);
        }
        return;
      }

      const data = await response.json();
      clearStatus();

      sellerNameEl.textContent = data.user.full_name || `User #${data.user.id}`;
      sellerEmailEl.textContent = data.user.email ? `(${data.user.email})` : '';
      if (data.summary.review_count) {
        const avgValue = typeof data.summary.average_rating === 'number'
          ? data.summary.average_rating.toFixed(1)
          : '0.0';
        sellerSummaryEl.innerHTML = `<strong>${avgValue}</strong> / 5<br><small>${data.summary.review_count} review(s)</small>`;
      } else {
        sellerSummaryEl.innerHTML = '<span class="text-muted">No reviews yet.</span>';
      }

      if (Array.isArray(data.reviews) && data.reviews.length) {
        reviewsList.innerHTML = data.reviews.map((review) => {
          return `
            <div class="card mb-3">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <h6 class="mb-1">Rating: ${review.rating}/5</h6>
                    <div class="text-muted small">Reviewer #${review.reviewer.id} (${escapeHtml(review.reviewer.full_name || 'Anonymous')})</div>
                  </div>
                  <small class="text-muted">${formatDate(review.created_at)}</small>
                </div>
                <p class="mb-0 mt-2">${review.body ? escapeHtml(review.body) : '<em>No comment provided.</em>'}</p>
              </div>
            </div>
          `;
        }).join('');
      } else {
        reviewsList.innerHTML = '<p class="text-muted">No reviews found for this seller.</p>';
      }

      resultsSection.style.display = 'block';
    } catch (error) {
      console.error('Error loading seller reviews', error);
      setStatus('Unexpected error loading reviews.', true);
    }
  });
})();
</script>
{% endblock %}
