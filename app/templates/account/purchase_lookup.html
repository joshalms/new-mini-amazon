{% extends "base.html" %}

{% block content %}
<br><br>
<h2>Lookup Purchases by User ID</h2>
<div class="container" style="max-width: 600px;">
  <form id="purchase-lookup-form" class="form-inline" onsubmit="return false;">
    <div class="form-group mb-2">
      <label for="lookup-user-id" class="sr-only">User ID</label>
      <input id="lookup-user-id" type="number" class="form-control" placeholder="User ID" min="1" required>
    </div>
    <button id="lookup-submit" class="btn btn-primary mb-2" type="button">Fetch Purchases</button>
  </form>

  <div id="lookup-status" class="mt-3"></div>

  <table id="lookup-results" class="table table-hover table-bordered mt-3" style="display: none;">
    <thead class="thead-dark">
      <tr>
        <th scope="col">Order #</th>
        <th scope="col">Date</th>
        <th scope="col">Product</th>
        <th scope="col">Quantity</th>
        <th scope="col">Unit Price</th>
        <th scope="col">Line Total</th>
        <th scope="col">Fulfilled?</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
(function() {
  const lookupButton = document.getElementById('lookup-submit');
  const userInput = document.getElementById('lookup-user-id');
  const statusContainer = document.getElementById('lookup-status');
  const resultsTable = document.getElementById('lookup-results');
  const resultsBody = resultsTable.querySelector('tbody');

  function setStatus(message, type) {
    const className = type === 'error' ? 'alert alert-danger' : 'alert alert-info';
    statusContainer.innerHTML = '<div class="' + className + '">' + message + '</div>';
  }

  function clearStatus() {
    statusContainer.innerHTML = '';
  }

  function centsToDollars(cents) {
    if (typeof cents !== 'number') return '$0.00';
    return '$' + (cents / 100).toFixed(2);
  }

  lookupButton.addEventListener('click', async function() {
    clearStatus();
    resultsTable.style.display = 'none';
    resultsBody.innerHTML = '';

    const rawId = userInput.value.trim();
    if (!rawId) {
      setStatus('Please enter a user ID.', 'error');
      return;
    }

    const userId = parseInt(rawId, 10);
    if (Number.isNaN(userId) || userId < 1) {
      setStatus('User ID must be a positive number.', 'error');
      return;
    }

    setStatus('Loading purchases...', 'info');

    try {
      const response = await fetch(`/api/users/${encodeURIComponent(userId)}/purchases`);
      if (!response.ok) {
        throw new Error('Request failed with status ' + response.status);
      }
      const data = await response.json();
      const items = Array.isArray(data.items) ? data.items : [];

      if (items.length === 0) {
        setStatus('No purchases found for user #' + userId + '.', 'info');
        return;
      }

      items.forEach(function(item) {
        const row = document.createElement('tr');
        const dateCell = item.order_created_at ? new Date(item.order_created_at).toLocaleString() : '';
        row.innerHTML = [
          '<th scope="row">' + item.order_id + '</th>',
          '<td>' + dateCell + '</td>',
          '<td>' + item.product_name + '</td>',
          '<td>' + item.quantity + '</td>',
          '<td>' + centsToDollars(item.unit_price_cents) + '</td>',
          '<td>' + centsToDollars(item.line_total_cents) + '</td>',
          '<td>' + (item.fulfilled ? 'Yes' : 'No') + '</td>'
        ].join('');
        resultsBody.appendChild(row);
      });

      clearStatus();
      resultsTable.style.display = '';
    } catch (err) {
      setStatus('Could not load purchases: ' + err.message, 'error');
    }
  });
})();
</script>
{% endblock %}
