{% extends "base.html" %}

{% block content %}
<div class="container" style="max-width: 640px; margin-top: 40px;">
  <h2>Public Profile</h2>
  <div class="card mb-4">
    <div class="card-body">
      <h4 class="card-title mb-1">{{ user.full_name }}</h4>
      <p class="text-muted mb-2">Account #{{ user.id }}</p>
      <div><strong>Email:</strong> {{ user.email }}</div>
      <div><strong>Address:</strong> {{ user.address }}</div>
      <div><strong>Member since:</strong> {{ user.created_at.strftime('%b %d, %Y') if user.created_at else '‚Äî' }}</div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6 mb-3">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">Purchase summary</h5>
          <p class="display-4 mb-1">{{ purchase_summary.order_count }}</p>
          <p class="text-muted">orders placed</p>
          <p class="mb-1"><strong>Total spent:</strong> {{ format_money(purchase_summary.total_cents) }}</p>
          <p>
            <strong>Most recent order:</strong>
            {% if purchase_summary.last_order_at %}
            {{ purchase_summary.last_order_at.strftime('%b %d, %Y') }}
            {% else %}
            Never
            {% endif %}
          </p>
        </div>
      </div>
    </div>
    <div class="col-md-6 mb-3">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">Seller rating</h5>
          {% if seller_summary.review_count %}
          <p class="display-4 mb-1">
            {{ '%.1f'|format(seller_summary.average_rating or 0) }}
            <small class="text-muted">/ 5</small>
          </p>
          <p class="text-muted">{{ seller_summary.review_count }} total reviews</p>
          {% else %}
          <p class="text-muted mb-0">No seller reviews yet.</p>
          {% endif %}
          {% if g.user and g.user.id != user.id %}
          <hr>
          {% if can_review %}
            {% if user_review %}
            <a href="{{ review_url }}" class="btn btn-sm btn-outline-primary">Edit your review</a>
            <span class="text-muted small ml-2">You rated {{ user_review.rating }}/5</span>
            {% else %}
            <a href="{{ review_url }}" class="btn btn-sm btn-primary">Write a review</a>
            {% endif %}
          {% else %}
          <span class="text-muted small">Order from this seller to leave a review</span>
          {% endif %}
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Seller Reviews</h3>
    <div>
      <span class="text-muted mr-2">Sort by:</span>
      <a href="{{ url_for('account.public_profile', user_id=user.id, sort='date') }}" class="btn btn-sm {{ 'btn-primary' if current_sort == 'date' else 'btn-outline-secondary' }}">Date</a>
      <a href="{{ url_for('account.public_profile', user_id=user.id, sort='rating') }}" class="btn btn-sm {{ 'btn-primary' if current_sort == 'rating' else 'btn-outline-secondary' }}">Rating</a>
      <a href="{{ url_for('account.public_profile', user_id=user.id, sort='helpful') }}" class="btn btn-sm {{ 'btn-primary' if current_sort == 'helpful' else 'btn-outline-secondary' }}">Helpful</a>
    </div>
  </div>
  {% if seller_reviews %}
  {% for review in seller_reviews %}
  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between">
        <h5 class="mb-1">Rating: {{ review.rating }}/5</h5>
        <small class="text-muted">
          {{ review.created_at.strftime('%b %d, %Y %I:%M %p') if review.created_at else '' }}
        </small>
      </div>
      <p class="mb-2">{{ review.body or 'No comment provided.' }}</p>
      <div class="d-flex justify-content-between align-items-center">
        <div class="text-muted small">By {{ review.reviewer_name }} (User #{{ review.reviewer_id }})</div>
        <div class="d-flex align-items-center">
          {% if g.user %}
          <button type="button" class="btn btn-sm {{ 'btn-success' if user_votes.get(review.id) == 1 else 'btn-outline-secondary' }} vote-btn mr-1" data-review-id="{{ review.id }}" data-type="seller" data-vote="1">
            üëç <span class="vote-count">{{ review.upvotes }}</span>
          </button>
          <button type="button" class="btn btn-sm {{ 'btn-danger' if user_votes.get(review.id) == -1 else 'btn-outline-secondary' }} vote-btn" data-review-id="{{ review.id }}" data-type="seller" data-vote="-1">
            üëé <span class="vote-count">{{ review.downvotes }}</span>
          </button>
          {% else %}
          <span class="text-muted small">üëç {{ review.upvotes }} ¬∑ üëé {{ review.downvotes }}</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
  {% else %}
  <p class="text-muted">This seller has not received any reviews yet.</p>
  {% endif %}
</div>

{% if g.user %}
<script>
(function() {
  document.querySelectorAll('.vote-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var reviewId = btn.dataset.reviewId;
      var reviewType = btn.dataset.type;
      var voteValue = parseInt(btn.dataset.vote, 10);
      var url = '/api/reviews/' + reviewType + '/' + reviewId + '/vote';

      fetch(url, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({vote: voteValue})
      })
      .then(function(res) { return res.json(); })
      .then(function(data) {
        var btns = document.querySelectorAll('.vote-btn[data-review-id="' + reviewId + '"]');
        btns.forEach(function(b) {
          var v = parseInt(b.dataset.vote, 10);
          b.querySelector('.vote-count').textContent = (v === 1) ? data.upvotes : data.downvotes;
          b.classList.remove('btn-success', 'btn-danger');
          if (data.user_vote === v) {
            b.classList.add(v === 1 ? 'btn-success' : 'btn-danger');
          } else {
            b.classList.add('btn-outline-secondary');
          }
        });
      })
      .catch(function(err) {
        console.error('vote error:', err);
      });
    });
  });
})();
</script>
{% endif %}
{% endblock %}
