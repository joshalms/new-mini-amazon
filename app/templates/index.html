{% extends "base.html" %}

{% block content %}

<!-- Cart button top right -->
<div style="position: absolute; top: 20px; right: 40px;">
  {% if g.user %}
    <a href="{{ url_for('cart.view_cart') }}" class="btn btn-outline-primary">
      <i class="fas fa-shopping-cart"></i> Cart
    </a>
  {% else %}
    <a href="{{ url_for('account.login', next=url_for('cart.view_cart')) }}" class="btn btn-outline-primary">
      <i class="fas fa-shopping-cart"></i> Cart
    </a>
  {% endif %}
</div>

<br><br>

<h2>Products for sale:</h2>
<p class="text-muted">Showing the first 50 available products.</p>
<div id="cart-inline-alert" class="alert" style="display:none;" role="alert"></div>

<table class='table table-hover table-bordered container'>
  <thead class="thead-dark">
    <tr>
      <th scope="col">Product ID</th>
      <th scope="col">Product Name</th>
      <th scope="col">Price</th>
      <th scope="col">Avg Rating</th>
      <th scope="col">Wishlist</th>
      <th scope="col">Cart</th>
    </tr>
  </thead>
  <tbody>
    {% for product in avail_products %}
      <tr>
        <th scope="row">{{ product.id }}</th>
        <td>{{ product.name }}</td>
        <td>{{ product.price }}</td>
        <td>
          {% if product.average_rating %}
            <a href="{{ url_for('products.product_reviews', product_id=product.id) }}">
              {{ '%.1f'|format(product.average_rating) }} / 5
            </a>
          {% else %}
            --
          {% endif %}
        </td>
        <td>
          {% if g.user %}
          <form action="{{ url_for('wishlist.wishlist_add', product_id=product.id) }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="submit" value="Add to Wishlist" class="btn btn-sm btn-outline-success"/>
          </form>
          {% else %}
          <a href="{{ url_for('account.login') }}">Log in</a>
          {% endif %}
        </td>
        <td>
          {% if g.user %}
          <button
            type="button"
            class="btn btn-sm btn-outline-primary add-to-cart-btn"
            data-product-id="{{ product.id }}"
            data-product-name="{{ product.name|e }}"
          >
            Add to Cart
          </button>
          {% else %}
          <a href="{{ url_for('account.login', next=url_for('cart.view_cart')) }}">Log in</a>
          {% endif %}
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<a href="{{ url_for('products.top_products') }}" class="btn btn-primary">
  View Top Products
</a>


<br><br>
{% if g.user %}
<h2>Your recent purchases:</h2>
{% if purchase_history %}
<table class="table table-hover table-bordered container">
  <thead class="thead-dark">
    <tr>
      <th scope="col">Order #</th>
      <th scope="col">Item</th>
      <th scope="col">Quantity</th>
      <th scope="col">Line total</th>
      <th scope="col">Purchased on</th>
    </tr>
  </thead>
  <tbody>
    {% for purchase in purchase_history %}
      <tr>
        <th scope="row">{{ purchase.order_id }}</th>
        <td>{{ purchase.product_name or ('Product #' ~ purchase.product_id) }}</td>
        <td>{{ purchase.quantity }}</td>
        <td>{{ format_money(purchase.line_total_cents) }}</td>
        <td>{{ purchase.created_at.strftime('%b %d, %Y') if purchase.created_at else '' }}</td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<p class="text-muted">We have not found any orders yet. Start shopping to see them here.</p>
{% endif %}
{% else %}
<p><a href="{{ url_for('account.login') }}">Log in</a> to see your purchase history!</p>
{% endif %}

{% if g.user %}
<script>
  (function () {
    const endpoint = {{ url_for('cart.api_add_item', user_id=g.user.id)|tojson }};
    const cartButtons = document.querySelectorAll('.add-to-cart-btn');
    const alertBox = document.getElementById('cart-inline-alert');

    if (!cartButtons.length) {
      return;
    }

    cartButtons.forEach((btn) => {
      btn.addEventListener('click', async () => {
        const productId = Number(btn.dataset.productId);
        if (!productId) {
          return;
        }

        const productName = btn.dataset.productName || 'item';
        const originalText = btn.textContent;
        const originalClasses = btn.className;
        btn.disabled = true;
        btn.textContent = 'Adding...';

        try {
          const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ product_id: productId, quantity: 1 }),
          });

          let payload = {};
          try {
            payload = await res.json();
          } catch (err) {
            payload = {};
          }

          if (!res.ok || payload.ok !== true) {
            const errMsg = payload.error || `Server error (${res.status})`;
            throw new Error(errMsg);
          }

          btn.classList.remove('btn-outline-primary');
          btn.classList.add('btn-success');
          btn.textContent = 'Added!';
          showAlert(`${productName} is now in your cart.`, 'success');
          setTimeout(() => {
            btn.disabled = false;
            btn.className = originalClasses;
            btn.textContent = originalText;
          }, 1500);
        } catch (err) {
          console.error(err);
          btn.disabled = false;
          btn.className = originalClasses;
          btn.textContent = originalText;
          showAlert(err.message || 'Unable to add to cart.', 'danger');
        }
      });
    });

    function showAlert(message, level) {
      if (!alertBox) {
        return;
      }
      alertBox.style.display = 'block';
      alertBox.textContent = message;
      alertBox.className = `alert alert-${level}`;
      clearTimeout(showAlert._timer);
      showAlert._timer = setTimeout(() => {
        alertBox.style.display = 'none';
      }, 4000);
    }
  })();
</script>
{% endif %}

{% endblock %}
