{% extends "base.html" %}

{% block content %}
<div class="container py-4" style="max-width: 960px;">
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h3 class="card-title mb-3">{{ product.name }}</h3>
      <div class="row">
        <div class="col-md-6">
          <p class="mb-1"><strong>Product ID:</strong> {{ product.id }}</p>
          <p class="mb-1"><strong>Price:</strong> ${{ product.price }}</p>
        </div>
        <div class="col-md-6">
          {% if summary.review_count %}
          <p class="h2 mb-1">
            {{ '%.1f'|format(summary.average_rating or 0) }}
            <small class="text-muted">/ 5</small>
          </p>
          <p class="text-muted">Based on {{ summary.review_count }} review{{ 's' if summary.review_count != 1 else '' }}</p>
          {% else %}
          <p class="text-muted">No reviews yet</p>
          {% endif %}
        </div>
      </div>
      {% if g.user %}
      <hr>
      <div class="d-flex align-items-center">
        {% if can_review %}
          {% if user_review %}
          <a href="{{ review_url }}" class="btn btn-outline-primary">Edit your review</a>
          <span class="ml-3 text-muted">You rated this {{ user_review.rating }}/5</span>
          {% else %}
          <a href="{{ review_url }}" class="btn btn-primary">Write a review</a>
          {% endif %}
        {% else %}
        <span class="text-muted">Purchase this product to leave a review</span>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">Customer Reviews</h4>
    <div>
      <span class="text-muted mr-2">Sort by:</span>
      <a href="{{ url_for('products.product_reviews', product_id=product.id, sort='date') }}" class="btn btn-sm {{ 'btn-primary' if current_sort == 'date' else 'btn-outline-secondary' }}">Date</a>
      <a href="{{ url_for('products.product_reviews', product_id=product.id, sort='rating') }}" class="btn btn-sm {{ 'btn-primary' if current_sort == 'rating' else 'btn-outline-secondary' }}">Rating</a>
      <a href="{{ url_for('products.product_reviews', product_id=product.id, sort='helpful') }}" class="btn btn-sm {{ 'btn-primary' if current_sort == 'helpful' else 'btn-outline-secondary' }}">Helpful</a>
    </div>
  </div>
  {% if reviews %}
  {% for review in reviews %}
  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between mb-2">
        <div>
          <strong>Rating: {{ review.rating }} / 5</strong>
          {% if review.rating == 5 %}
            <span class="text-warning">â˜…â˜…â˜…â˜…â˜…</span>
          {% elif review.rating == 4 %}
            <span class="text-warning">â˜…â˜…â˜…â˜…</span><span class="text-muted">â˜…</span>
          {% elif review.rating == 3 %}
            <span class="text-warning">â˜…â˜…â˜…</span><span class="text-muted">â˜…â˜…</span>
          {% elif review.rating == 2 %}
            <span class="text-warning">â˜…â˜…</span><span class="text-muted">â˜…â˜…â˜…</span>
          {% elif review.rating == 1 %}
            <span class="text-warning">â˜…</span><span class="text-muted">â˜…â˜…â˜…â˜…</span>
          {% endif %}
        </div>
        <small class="text-muted">
          {{ review.created_at.strftime('%b %d, %Y %I:%M %p') if review.created_at else '' }}
        </small>
      </div>
      <p class="mb-2">{{ review.body or 'No comment provided.' }}</p>
      <div class="d-flex justify-content-between align-items-center">
        <div class="text-muted small">
          By {{ review.reviewer_name }} (User #{{ review.reviewer_id }})
          {% if review.updated_at and review.updated_at != review.created_at %}
          <em>Â· Edited {{ review.updated_at.strftime('%b %d, %Y') }}</em>
          {% endif %}
        </div>
        <div class="d-flex align-items-center">
          {% if g.user %}
          <button type="button" class="btn btn-sm {{ 'btn-success' if user_votes.get(review.id) == 1 else 'btn-outline-secondary' }} vote-btn mr-1" data-review-id="{{ review.id }}" data-type="product" data-vote="1">
            ğŸ‘ <span class="vote-count">{{ review.upvotes }}</span>
          </button>
          <button type="button" class="btn btn-sm {{ 'btn-danger' if user_votes.get(review.id) == -1 else 'btn-outline-secondary' }} vote-btn" data-review-id="{{ review.id }}" data-type="product" data-vote="-1">
            ğŸ‘ <span class="vote-count">{{ review.downvotes }}</span>
          </button>
          {% else %}
          <span class="text-muted small">ğŸ‘ {{ review.upvotes }} Â· ğŸ‘ {{ review.downvotes }}</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
  {% else %}
  <div class="alert alert-info">
    This product hasn't received any reviews yet. Be the first to review it!
  </div>
  {% endif %}

  <div class="mt-4">
    <a href="{{ url_for('index.index') }}" class="btn btn-secondary">Back to Products</a>
  </div>
</div>

{% if g.user %}
<script>
(function() {
  document.querySelectorAll('.vote-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var reviewId = btn.dataset.reviewId;
      var reviewType = btn.dataset.type;
      var voteValue = parseInt(btn.dataset.vote, 10);
      var url = '/api/reviews/' + reviewType + '/' + reviewId + '/vote';

      fetch(url, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({vote: voteValue})
      })
      .then(function(res) { return res.json(); })
      .then(function(data) {
        // find sibling buttons for same review
        var btns = document.querySelectorAll('.vote-btn[data-review-id="' + reviewId + '"]');
        btns.forEach(function(b) {
          var v = parseInt(b.dataset.vote, 10);
          b.querySelector('.vote-count').textContent = (v === 1) ? data.upvotes : data.downvotes;
          b.classList.remove('btn-success', 'btn-danger');
          if (data.user_vote === v) {
            b.classList.add(v === 1 ? 'btn-success' : 'btn-danger');
          } else {
            b.classList.add('btn-outline-secondary');
          }
        });
      })
      .catch(function(err) {
        console.error('vote error:', err);
      });
    });
  });
})();
</script>
{% endif %}
{% endblock %}