{% extends "base.html" %}

{% block content %}
<div class="container py-4" style="max-width: 720px;">
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h3 class="card-title mb-2">Public Profile</h3>
      <p class="text-muted mb-4">Account #{{ user_info.id }}</p>
      <dl class="row">
        <dt class="col-sm-4">Full Name</dt>
        <dd class="col-sm-8">{{ user_info.full_name }}</dd>
        {% if is_seller %}
        <dt class="col-sm-4">Email</dt>
        <dd class="col-sm-8">{{ user_info.email }}</dd>
        <dt class="col-sm-4">Address</dt>
        <dd class="col-sm-8">{{ user_info.address }}</dd>
        {% else %}
        <dt class="col-sm-4">Email</dt>
        <dd class="col-sm-8 text-muted">Hidden (not a seller)</dd>
        <dt class="col-sm-4">Address</dt>
        <dd class="col-sm-8 text-muted">Hidden (not a seller)</dd>
        {% endif %}
        <dt class="col-sm-4">Member Since</dt>
        <dd class="col-sm-8">{{ user_info.created_at.strftime('%b %d, %Y') if user_info.created_at else '' }}</dd>
      </dl>
      <div class="mt-4 d-flex flex-wrap align-items-center" style="gap: 0.5rem;">
        {% if g.user and g.user.id == user_info.id %}
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('users.users_me') }}" style="margin-right: 0.25rem;">My Account</a>
        {% endif %}
        {% if is_seller %}
        <a class="btn btn-primary btn-sm" href="{{ url_for('inventory.view_inventory', user_id=user_info.id) }}">View Inventory</a>
        {% endif %}
      </div>
    </div>
  </div>

  {% if is_seller %}
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <h5 class="card-title">Seller Rating</h5>
      {% if seller_summary.review_count %}
      <p class="h2 mb-1">
        {{ '%.1f'|format(seller_summary.average_rating or 0) }}
        <small class="text-muted">/ 5</small>
      </p>
      <p class="text-muted">{{ seller_summary.review_count }} total reviews</p>
      {% else %}
      <p class="text-muted mb-0">No seller reviews yet.</p>
      {% endif %}
      {% if g.user and g.user.id != user_info.id %}
      <hr>
      {% if can_review %}
        {% if user_review %}
        <a href="{{ review_url }}" class="btn btn-sm btn-outline-primary">Edit your review</a>
        <span class="text-muted small ml-2">You rated {{ user_review.rating }}/5</span>
        {% else %}
        <a href="{{ review_url }}" class="btn btn-sm btn-primary">Write a review</a>
        {% endif %}
      {% else %}
      <span class="text-muted small">Order from this seller to leave a review</span>
      {% endif %}
      {% endif %}
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="card-title mb-0">Seller Reviews</h5>
        <div>
          <span class="text-muted mr-2 small">Sort:</span>
          <a href="{{ url_for('users.public_profile', user_id=user_info.id, sort='date') }}" class="btn btn-sm {{ 'btn-primary' if current_sort == 'date' else 'btn-outline-secondary' }}">Date</a>
          <a href="{{ url_for('users.public_profile', user_id=user_info.id, sort='rating') }}" class="btn btn-sm {{ 'btn-primary' if current_sort == 'rating' else 'btn-outline-secondary' }}">Rating</a>
          <a href="{{ url_for('users.public_profile', user_id=user_info.id, sort='helpful') }}" class="btn btn-sm {{ 'btn-primary' if current_sort == 'helpful' else 'btn-outline-secondary' }}">Helpful</a>
        </div>
      </div>
      {% if seller_reviews %}
      {% for review in seller_reviews %}
      <div class="border rounded p-3 mb-3">
        <div class="d-flex justify-content-between mb-2">
          <strong>Rating: {{ review.rating }}/5</strong>
          <small class="text-muted">
            {{ review.created_at.strftime('%b %d, %Y %I:%M %p') if review.created_at else '' }}
          </small>
        </div>
        <p class="mb-2">{{ review.body or 'No comment provided.' }}</p>
        <div class="d-flex justify-content-between align-items-center">
          <div class="text-muted small">By {{ review.reviewer_name }} (User #{{ review.reviewer_id }})</div>
          <div class="d-flex align-items-center">
            {% if g.user %}
            <button type="button" class="btn btn-sm {{ 'btn-success' if user_votes.get(review.id) == 1 else 'btn-outline-secondary' }} vote-btn mr-1" data-review-id="{{ review.id }}" data-type="seller" data-vote="1">
              üëç <span class="vote-count">{{ review.upvotes }}</span>
            </button>
            <button type="button" class="btn btn-sm {{ 'btn-danger' if user_votes.get(review.id) == -1 else 'btn-outline-secondary' }} vote-btn" data-review-id="{{ review.id }}" data-type="seller" data-vote="-1">
              üëé <span class="vote-count">{{ review.downvotes }}</span>
            </button>
            {% else %}
            <span class="text-muted small">üëç {{ review.upvotes }} ¬∑ üëé {{ review.downvotes }}</span>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
      {% else %}
      <p class="text-muted mb-0">This seller has not received any reviews yet.</p>
      {% endif %}
    </div>
  </div>
  {% else %}
  <div class="alert alert-info">This user has not sold any items yet, so seller details are hidden.</div>
  {% endif %}
</div>

{% if g.user %}
<script>
(function() {
  document.querySelectorAll('.vote-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var reviewId = btn.dataset.reviewId;
      var reviewType = btn.dataset.type;
      var voteValue = parseInt(btn.dataset.vote, 10);
      var url = '/api/reviews/' + reviewType + '/' + reviewId + '/vote';

      fetch(url, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({vote: voteValue})
      })
      .then(function(res) { return res.json(); })
      .then(function(data) {
        var btns = document.querySelectorAll('.vote-btn[data-review-id="' + reviewId + '"]');
        btns.forEach(function(b) {
          var v = parseInt(b.dataset.vote, 10);
          b.querySelector('.vote-count').textContent = (v === 1) ? data.upvotes : data.downvotes;
          b.classList.remove('btn-success', 'btn-danger');
          if (data.user_vote === v) {
            b.classList.add(v === 1 ? 'btn-success' : 'btn-danger');
          } else {
            b.classList.add('btn-outline-secondary');
          }
        });
      })
      .catch(function(err) {
        console.error('vote error:', err);
      });
    });
  });
})();
</script>
{% endif %}
{% endblock %}
