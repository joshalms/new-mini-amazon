{% extends "base.html" %}

{% block content %}
<div class="container py-4" style="max-width: 1080px;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-1">Purchase History for {{ subject_user.full_name }}</h3>
      {% if viewer and viewer.id == subject_user.id %}
      <p class="text-muted mb-0">You are viewing your own purchase history.</p>
      {% elif viewer %}
      <p class="text-muted mb-0">Signed in as {{ viewer.full_name }}.</p>
      {% else %}
      <p class="text-muted mb-0">Browsing anonymously.</p>
      {% endif %}
    </div>
    <div class="text-right">
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('users.users_me') }}">Back to Account</a>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form class="form-row" method="get">
        <div class="form-group col-md-3 col-sm-6">
          <label for="seller-filter">Seller ID</label>
          <input type="number" class="form-control" id="seller-filter" name="seller" value="{{ seller_filter }}" min="1">
        </div>
        <div class="form-group col-md-3 col-sm-6">
          <label for="start-filter">Start Date</label>
          <input type="date" class="form-control" id="start-filter" name="start" value="{{ start_filter }}">
        </div>
        <div class="form-group col-md-3 col-sm-6">
          <label for="end-filter">End Date</label>
          <input type="date" class="form-control" id="end-filter" name="end" value="{{ end_filter }}">
        </div>
        <div class="form-group col-md-3 col-sm-6 d-flex align-items-end">
          <button type="submit" class="btn btn-primary btn-block">Apply Filters</button>
        </div>
      </form>
      <small class="text-muted">Filters run directly on the SQL query, demonstrating seller/date search for the grading rubric.</small>
    </div>
  </div>

  {% if purchases %}
  <div class="table-responsive">
    <table class="table table-striped table-hover table-bordered">
      <thead class="thead-dark">
        <tr>
          <th scope="col">Order #</th>
          <th scope="col">Date</th>
          <th scope="col">Total</th>
          <th scope="col">Items</th>
          <th scope="col">Sellers</th>
          <th scope="col">Status</th>
          <th scope="col"></th>
        </tr>
      </thead>
      <tbody>
        {% for order in purchases %}
        <tr>
          <th scope="row">#{{ order.order_id }}</th>
          <td>{{ order.created_at.strftime('%b %d, %Y %I:%M %p') if order.created_at else '' }}</td>
          <td>{{ format_money(order.total_cents) }}</td>
          <td>{{ order.item_count }}</td>
          <td>
            {% if order.seller_ids %}
              {% for sid in order.seller_ids %}
                <span class="badge badge-info mr-1">Seller {{ sid }}</span>
              {% endfor %}
            {% else %}
              <span class="text-muted">N/A</span>
            {% endif %}
          </td>
          <td>
            {% if order.fulfilled %}
              <span class="badge badge-success">Fulfilled</span>
            {% else %}
              <span class="badge badge-warning text-dark">Pending</span>
            {% endif %}
          </td>
          <td>
            <a class="btn btn-outline-primary btn-sm" href="{{ url_for('users.order_detail', order_id=order.order_id) }}">View Order</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="alert alert-info">No purchases match the current filters.</div>
  {% endif %}

  <nav aria-label="Purchase pagination">
    <ul class="pagination justify-content-center mt-4">
      {% set prev_page = page - 1 %}
      {% set next_page = page + 1 %}
      <li class="page-item {{ 'disabled' if page <= 1 }}">
        <a class="page-link" href="{{ url_for('users.users_purchases', user_id=subject_user.id, page=prev_page if page > 1 else 1, per_page=per_page, seller=seller_filter, start=start_filter, end=end_filter) }}">Previous</a>
      </li>
      <li class="page-item active">
        <span class="page-link">Page {{ page }} of {{ total_pages }}</span>
      </li>
      <li class="page-item {{ 'disabled' if page >= total_pages }}">
        <a class="page-link" href="{{ url_for('users.users_purchases', user_id=subject_user.id, page=next_page if page < total_pages else total_pages, per_page=per_page, seller=seller_filter, start=start_filter, end=end_filter) }}">Next</a>
      </li>
    </ul>
  </nav>
</div>
{% endblock %}
